function method(a,b){return function(){a[b].apply(a,arguments)}}function forEach(a,b){if(a.next)try{for(;;)b(a.next())}catch(c){if(c!=StopIteration)throw c}else for(var d=0;d<a.length;d++)b(a[d])}function map(a,b){var c=[];return forEach(a,function(a){c.push(b(a))}),c}function matcher(a){return function(b){return a.test(b)}}function hasClass(a,b){var c=a.className;return c&&new RegExp("(^| )"+b+"($| )").test(c)}function removeClass(a,b){return a.className=a.className.replace(new RegExp(" "+b+"\\b","g"),""),a}function insertAfter(a,b){var c=b.parentNode;return c.insertBefore(a,b.nextSibling),a}function removeElement(a){a.parentNode&&a.parentNode.removeChild(a)}function clearElement(a){for(;a.firstChild;)a.removeChild(a.firstChild)}function isAncestor(a,b){for(;b=b.parentNode;)if(a==b)return!0;return!1}function normalizeEvent(a){return a.stopPropagation||(a.stopPropagation=function(){this.cancelBubble=!0},a.preventDefault=function(){this.returnValue=!1}),a.stop||(a.stop=function(){this.stopPropagation(),this.preventDefault()}),"keypress"==a.type&&(a.code=null==a.charCode?a.keyCode:a.charCode,a.character=String.fromCharCode(a.code)),a}function addEventHandler(a,b,c,d){function e(a){c(normalizeEvent(a||window.event))}if("function"==typeof a.addEventListener){if(a.addEventListener(b,e,!1),d)return function(){a.removeEventListener(b,e,!1)}}else if(a.attachEvent("on"+b,e),d)return function(){a.detachEvent("on"+b,e)}}function nodeText(a){return a.textContent||a.innerText||a.nodeValue||""}function nodeTop(a){for(var b=0;a.offsetParent;)b+=a.offsetTop,a=a.offsetParent;return b}function isBR(a){var b=a.nodeName;return"BR"==b||"br"==b}function isSpan(a){var b=a.nodeName;return"SPAN"==b||"span"==b}function UndoHistory(a,b,c,d){this.container=a,this.maxDepth=b,this.commitDelay=c,this.editor=d;var e={text:"",from:null,to:null};this.first=e,this.last=e,this.firstTouched=!1,this.history=[],this.redoHistory=[],this.touched=[],this.lostundo=0}function makeWhiteSpace(a){for(var b=[],c=!0;a>0;a--)b.push(c||1==a?nbsp:" "),c^=!0;return b.join("")}function fixSpaces(a){return" "==a.charAt(0)&&(a=nbsp+a.slice(1)),a.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(a){return makeWhiteSpace(a.length)})}function cleanText(a){return a.replace(/\u00a0/g," ").replace(/\u200b/g,"")}function makePartSpan(a){var b=a;3==a.nodeType?b=a.nodeValue:a=document.createTextNode(b);var c=document.createElement("span");return c.isPart=!0,c.appendChild(a),c.currentText=b,c}function alwaysZero(){return 0}function asEditorLines(a){var b=makeWhiteSpace(indentUnit);return map(a.replace(/\t/g,b).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}function tokenizer(a,b){function c(a){return"\n"!=a&&/^[\s\u00a0]*$/.test(a)}var d={state:b,take:function(b){return"string"==typeof b&&(b={style:b,type:b}),b.content=(b.content||"")+a.get(),/\n$/.test(b.content)||a.nextWhile(c),b.value=b.content+a.get(),b},next:function(){if(!a.more())throw StopIteration;var b;if(a.equals("\n"))return a.next(),this.take("whitespace");if(a.applies(c))b="whitespace";else for(;!b;)b=this.state(a,function(a){d.state=a});return this.take(b)}};return d}function findFirstRegexp(a){return new RegExp("^(?:"+a.join("|")+")","i")}function matchRegexp(a){return new RegExp("^(?:"+a.join("|")+")$","i")}function configureLUA(a){a&&(luaCustomFunctions=matchRegexp(a))}var StopIteration={toString:function(){return"StopIteration"}},nbsp="\xa0",matching={"{":"}","[":"]","(":")","}":"{","]":"[",")":"("},stringStream=function(a){function e(){for(;c==b.length;){d+=b,b="",c=0;try{b=a.next()}catch(e){if(e!=StopIteration)throw e;return!1}}return!0}var b="",c=0,d="";return{peek:function(){return e()?b.charAt(c):null},next:function(){if(!e())throw d.length>0?"End of stringstream reached without emptying buffer ('"+d+"').":StopIteration;return b.charAt(c++)},get:function(){var a=d;return d="",c>0&&(a+=b.slice(0,c),b=b.slice(c),c=0),a},push:function(a){b=b.slice(0,c)+a+b.slice(c)},lookAhead:function(e,f,g,h){function i(a){return h?a.toLowerCase():a}e=i(e);var j=!1,k=d,l=c;for(g&&this.nextWhileMatches(/[\s\u00a0]/);;){var m=c+e.length,n=b.length-c;if(m<=b.length){j=e==i(b.slice(c,m)),c=m;break}if(e.slice(0,n)!=i(b.slice(c)))break;d+=b,b="";try{b=a.next()}catch(o){if(o!=StopIteration)throw o;break}c=0,e=e.slice(n)}return j&&f||(b=d.slice(k.length)+b,c=l,d=k),j},lookAheadRegex:function(d,e){if("^"!=d.source.charAt(0))throw new Error("Regexps passed to lookAheadRegex must start with ^");for(;-1==b.indexOf("\n",c);)try{b+=a.next()}catch(f){if(f!=StopIteration)throw f;break}var g=b.slice(c).match(d);return g&&e&&(c+=g[0].length),g},more:function(){return null!==this.peek()},applies:function(a){var b=this.peek();return null!==b&&a(b)},nextWhile:function(a){for(var b;null!==(b=this.peek())&&a(b);)this.next()},matches:function(a){var b=this.peek();return null!==b&&a.test(b)},nextWhileMatches:function(a){for(var b;null!==(b=this.peek())&&a.test(b);)this.next()},equals:function(a){return a===this.peek()},endOfLine:function(){var a=this.peek();return null==a||"\n"==a}}},select={};!function(){function a(a,b){for(;a&&a.parentNode!=b;)a=a.parentNode;return a}function b(b,c){for(;!b.previousSibling&&b.parentNode!=c;)b=b.parentNode;return a(b.previousSibling,c)}function e(a){var b=a.nextSibling;if(b){for(;b.firstChild;)b=b.firstChild;return 3==b.nodeType||isBR(b)?b:e(b)}for(var c=a.parentNode;c&&!c.nextSibling;)c=c.parentNode;return c&&e(c)}function f(){var a=document.selection;return a?a.createRange?a.createRange():a.createTextRange():null}function g(a){function c(a){for(var b=null;!b&&a;)b=a.nextSibling,a=a.parentNode;return d(b)}function d(a){for(;a&&a.firstChild;)a=a.firstChild;return{node:a,offset:0}}var b=f();b.collapse(a);var e=b.parentElement();if(!isAncestor(document.body,e))return null;if(!e.firstChild)return d(e);var g=b.duplicate();g.moveToElementText(e),g.collapse(!0);for(var h=e.firstChild;h;h=h.nextSibling){if(3==h.nodeType){var i=h.nodeValue.length;g.move("character",i)}else g.moveToElementText(h),g.collapse(!1);var j=b.compareEndPoints("StartToStart",g);if(0==j)return c(h);if(1!=j)return 3!=h.nodeType?d(h):(g.setEndPoint("StartToEnd",b),{node:h,offset:i-g.text.length})}return c(e)}function h(a){var b=f();b&&(b.pasteHTML(a),b.collapse(!1),b.select())}function i(a,b){for(;3!=a.nodeType&&!isBR(a);){var c=a.childNodes[b]||a.nextSibling;for(b=0;!c&&a.parentNode;)a=a.parentNode,c=a.nextSibling;if(a=c,!c)break}return{node:a,offset:b}}function j(a){var b=window.getSelection();b&&(b.removeAllRanges(),b.addRange(a))}function k(){var a=window.getSelection();return a&&0!=a.rangeCount?a.getRangeAt(0):!1}select.ie_selection=!(window.getSelection&&document.createRange&&document.createRange().endContainer);var c="\xa0\xa0\xa0\xa0";select.scrollToNode=function(a,b){if(a){for(var c=a,d=document.body,e=document.documentElement,f=!c.nextSibling||!c.nextSibling.nextSibling||!c.nextSibling.nextSibling.nextSibling,g=0;c&&!c.offsetTop;)g++,c=c.previousSibling;if(0==g&&(f=!1),!webkit||!c||5!=c.offsetTop||5!=c.offsetLeft){for(var h=g*(c?c.offsetHeight:0),i=0,j=a?a.offsetWidth:0,k=c;k&&k.offsetParent;)h+=k.offsetTop,isBR(k)||(i+=k.offsetLeft),k=k.offsetParent;var l=d.scrollLeft||e.scrollLeft||0,m=d.scrollTop||e.scrollTop||0,n=!1,o=window.innerWidth||e.clientWidth||0;if(b||o>j){if(b){var p=select.offsetInNode(a),q=nodeText(a).length;q&&(i+=j*(p/q))}var r=i-l;(0>r||r>o)&&(l=i,n=!0)}var s=h-m;(0>s||f||s>(window.innerHeight||e.clientHeight||0)-50)&&(m=f?1e6:h,n=!0),n&&window.scrollTo(l,m)}}},select.scrollToCursor=function(a){select.scrollToNode(select.selectionTopNode(a,!0)||a.firstChild,!0)};var d=null;select.snapshotChanged=function(){d&&(d.changed=!0)},select.snapshotReplaceNode=function(a,b,c,f){function g(g){a==g.node?(d.changed=!0,c&&g.offset>c?g.offset-=c:(g.node=b,g.offset+=f||0)):select.ie_selection&&0==g.offset&&g.node==e(a)&&(d.changed=!0)}d&&(g(d.start),g(d.end))},select.snapshotMove=function(a,b,c,e,f){function g(g){a!=g.node||f&&0!=g.offset||(d.changed=!0,g.node=b,g.offset=e?Math.max(0,g.offset+c):c)}d&&(g(d.start),g(d.end))},select.ie_selection?(select.markSelection=function(){d=null;var a=document.selection;if(a){var b=g(!0),c=g(!1);b&&c&&(d={start:b,end:c,changed:!1})}},select.selectMarked=function(){function a(a){var b=document.body.createTextRange(),c=a.node;if(c)if(3==c.nodeType){b.moveToElementText(c.parentNode);for(var d=a.offset;c.previousSibling;)c=c.previousSibling,d+=(c.innerText||"").length;b.move("character",d)}else b.moveToElementText(c),b.collapse(!0);else b.moveToElementText(document.body),b.collapse(!1);return b}if(d&&d.changed){var b=a(d.start),c=a(d.end);b.setEndPoint("StartToEnd",c),b.select()}},select.offsetInNode=function(a){var b=f();if(!b)return 0;var c=b.duplicate();try{c.moveToElementText(a)}catch(d){return 0}return b.setEndPoint("StartToStart",c),b.text.length},select.selectionTopNode=function(b,c){function h(a,b){if(3==b.nodeType){for(var c=0,d=b.previousSibling;d&&3==d.nodeType;)c+=d.nodeValue.length,d=d.previousSibling;if(d){try{a.moveToElementText(d)}catch(e){return!1}a.collapse(!1)}else a.moveToElementText(b.parentNode);c&&a.move("character",c)}else try{a.moveToElementText(b)}catch(e){return!1}return!0}var d=f();if(!d)return!1;var e=d.duplicate();d.collapse(c);var g=d.parentElement();if(g&&isAncestor(b,g)&&(e.moveToElementText(g),1==d.compareEndPoints("StartToStart",e)))return a(g,b);for(var c=0,i=b.childNodes.length-1;i>c;){var j=Math.ceil((i+c)/2),k=b.childNodes[j];if(!k)return!1;if(!h(e,k))return!1;1==d.compareEndPoints("StartToStart",e)?c=j:i=j-1}if(0==c){var l=f(),m=l.duplicate();try{m.moveToElementText(b)}catch(n){return null}if(0==l.compareEndPoints("StartToStart",m))return null}return b.childNodes[c]||null},select.focusAfterNode=function(a,b){var c=document.body.createTextRange();c.moveToElementText(a||b),c.collapse(!a),c.select()},select.somethingSelected=function(){var a=f();return a&&""!=a.text},select.insertNewlineAtCursor=function(){h("<br>")},select.insertTabAtCursor=function(){h(c)},select.cursorPos=function(a,b){var c=f();if(!c)return null;for(var d=select.selectionTopNode(a,b);d&&!isBR(d);)d=d.previousSibling;var e=c.duplicate();if(c.collapse(b),d)e.moveToElementText(d),e.collapse(!1);else{try{e.moveToElementText(a)}catch(g){return null}e.collapse(!0)}return c.setEndPoint("StartToStart",e),{node:d,offset:c.text.length}},select.setCursorPos=function(a,b,c){function d(b){var c=document.body.createTextRange();return b.node?(c.moveToElementText(b.node),c.collapse(!1)):(c.moveToElementText(a),c.collapse(!0)),c.move("character",b.offset),c}var e=d(b);c&&c!=b&&e.setEndPoint("EndToEnd",d(c)),e.select()},select.getBookmark=function(a){var b=select.cursorPos(a,!0),c=select.cursorPos(a,!1);return b&&c?{from:b,to:c}:void 0},select.setBookmark=function(a,b){b&&select.setCursorPos(a,b.from,b.to)}):(select.markSelection=function(){var a=window.getSelection();if(!a||0==a.rangeCount)return d=null;var b=a.getRangeAt(0);d={start:i(b.startContainer,b.startOffset),end:i(b.endContainer,b.endOffset),changed:!1}},select.selectMarked=function(){function b(){if(a.start.node==a.end.node&&a.start.offset==a.end.offset){var b=window.getSelection();if(!b||0==b.rangeCount)return!0;var c=b.getRangeAt(0),d=i(c.startContainer,c.startOffset);return a.start.node!=d.node||a.start.offset!=d.offset}}function e(a,b){a.node?0==a.offset?c["set"+b+"Before"](a.node):c["set"+b](a.node,a.offset):c.setStartAfter(document.body.lastChild||document.body)}var a=d;if(a&&(a.changed||webkit&&b())){var c=document.createRange();e(a.end,"End"),e(a.start,"Start"),j(c)}},select.selectionTopNode=function(c,d){var e=k();if(!e)return!1;var f=d?e.startContainer:e.endContainer,g=d?e.startOffset:e.endOffset;return window.opera&&!d&&e.endContainer==c&&e.endOffset==e.startOffset+1&&c.childNodes[e.startOffset]&&isBR(c.childNodes[e.startOffset])&&g--,3==f.nodeType?g>0?a(f,c):b(f,c):"HTML"==f.nodeName.toUpperCase()?1==g?null:c.lastChild:f==c?0==g?null:f.childNodes[g-1]:g==f.childNodes.length?a(f,c):0==g?b(f,c):a(f.childNodes[g-1],c)},select.focusAfterNode=function(a,b){var c=document.createRange();c.setStartBefore(b.firstChild||b),a&&!a.firstChild?c.setEndAfter(a):a?c.setEnd(a,a.childNodes.length):c.setEndBefore(b.firstChild||b),c.collapse(!1),j(c)},select.somethingSelected=function(){var a=k();return a&&!a.collapsed},select.offsetInNode=function(a){var b=k();return b?(b=b.cloneRange(),b.setStartBefore(a),b.toString().length):0},select.insertNodeAtCursor=function(a){var b=k();if(b){if(b.deleteContents(),b.insertNode(a),webkitLastLineHack(document.body),window.opera&&isBR(a)&&isSpan(a.parentNode)){var c=a.nextSibling,d=a.parentNode,e=d.parentNode;e.insertBefore(a,d.nextSibling);for(var f="";c&&3==c.nodeType;c=c.nextSibling)f+=c.nodeValue,removeElement(c);e.insertBefore(makePartSpan(f,document),a.nextSibling)}b=document.createRange(),b.selectNode(a),b.collapse(!1),j(b)}},select.insertNewlineAtCursor=function(){select.insertNodeAtCursor(document.createElement("BR"))},select.insertTabAtCursor=function(){select.insertNodeAtCursor(document.createTextNode(c))},select.cursorPos=function(a,b){var c=k();if(c){for(var d=select.selectionTopNode(a,b);d&&!isBR(d);)d=d.previousSibling;c=c.cloneRange(),c.collapse(b),d?c.setStartAfter(d):c.setStartBefore(a);var e=c.toString();return{node:d,offset:e.length}}},select.setCursorPos=function(a,b,c){function e(b,c,e){function g(a){3==a.nodeType?f.push(a):forEach(a.childNodes,g)}if(0==c&&b&&!b.nextSibling)return d["set"+e+"After"](b),!0;if(b=b?b.nextSibling:a.firstChild){if(0==c)return d["set"+e+"Before"](b),!0;for(var f=[];;){for(;b&&!f.length;)g(b),b=b.nextSibling;var h=f.shift();if(!h)return!1;var i=h.nodeValue.length;if(i>=c)return d["set"+e](h,c),!0;c-=i}}}var d=document.createRange();c=c||b,e(c.node,c.offset,"End")&&e(b.node,b.offset,"Start")&&j(d)})}(),UndoHistory.prototype={scheduleCommit:function(){var a=this;parent.clearTimeout(this.commitTimeout),this.commitTimeout=parent.setTimeout(function(){a.tryCommit()},this.commitDelay)},touch:function(a){this.setTouched(a),this.scheduleCommit()},undo:function(){if(this.commit(),this.history.length){var a=this.history.pop();return this.redoHistory.push(this.updateTo(a,"applyChain")),this.notifyEnvironment(),this.chainNode(a)}},redo:function(){if(this.commit(),this.redoHistory.length){var a=this.redoHistory.pop();return this.addUndoLevel(this.updateTo(a,"applyChain")),this.notifyEnvironment(),this.chainNode(a)}},clear:function(){this.history=[],this.redoHistory=[],this.lostundo=0},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length,lostundo:this.lostundo}},push:function(a,b,c){for(var d=[],e=0;e<c.length;e++){var f=e==c.length-1?b:document.createElement("br");d.push({from:a,to:f,text:cleanText(c[e])}),a=f}this.pushChains([d],null==a&&null==b),this.notifyEnvironment()},pushChains:function(a,b){this.commit(b),this.addUndoLevel(this.updateTo(a,"applyChain")),this.redoHistory=[]},chainNode:function(a){for(var b=0;b<a.length;b++){var c=a[b][0],d=c&&(c.from||c.to);if(d)return d}},reset:function(){this.history=[],this.redoHistory=[],this.lostundo=0},textAfter:function(a){return this.after(a).text},nodeAfter:function(a){return this.after(a).to},nodeBefore:function(a){return this.before(a).from},tryCommit:function(){window&&window.parent&&window.UndoHistory&&(this.editor.highlightDirty()?this.commit(!0):this.scheduleCommit())},commit:function(a){parent.clearTimeout(this.commitTimeout),a||this.editor.highlightDirty(!0);var b=this.touchedChains();b.length&&(this.addUndoLevel(this.updateTo(b,"linkChain")),this.redoHistory=[],this.notifyEnvironment())},updateTo:function(a,b){for(var c=[],d=[],e=0;e<a.length;e++)c.push(this.shadowChain(a[e])),d.push(this[b](a[e]));return"applyChain"==b&&this.notifyDirty(d),c},notifyDirty:function(a){forEach(a,method(this.editor,"addDirtyNode")),this.editor.scheduleHighlight()},notifyEnvironment:function(){this.onChange&&this.onChange(this.editor),window.frameElement&&window.frameElement.CodeMirror.updateNumbers&&window.frameElement.CodeMirror.updateNumbers()},linkChain:function(a){for(var b=0;b<a.length;b++){var c=a[b];c.from?c.from.historyAfter=c:this.first=c,c.to?c.to.historyBefore=c:this.last=c}},after:function(a){return a?a.historyAfter:this.first},before:function(a){return a?a.historyBefore:this.last},setTouched:function(a){a?a.historyTouched||(this.touched.push(a),a.historyTouched=!0):this.firstTouched=!0},addUndoLevel:function(a){this.history.push(a),this.history.length>this.maxDepth&&(this.history.shift(),this.lostundo+=1)},touchedChains:function(){function c(a){return a?a.historyTemp:b}function d(a,c){a?a.historyTemp=c:b=c}function e(b){for(var c=[],d=b?b.nextSibling:a.container.firstChild;d&&(!isBR(d)||d.hackBR);d=d.nextSibling)!d.hackBR&&d.currentText&&c.push(d.currentText);return{from:b,to:d,text:cleanText(c.join(""))}}function g(a,b){for(var c=b+"Sibling",d=a[c];d&&!isBR(d);)d=d[c];return d}var a=this,b=null,f=[];a.firstTouched&&a.touched.push(null),forEach(a.touched,function(b){if(!b||b.parentNode==a.container&&!b.hackBR){b?b.historyTouched=!1:a.firstTouched=!1;var c=e(b),g=a.after(b);g&&g.text==c.text&&g.to==c.to||(f.push(c),d(b,c))}});var h=[];return a.touched=[],forEach(f,function(b){if(c(b.from)){for(var f=[],i=b.from,j=!0;;){var k=c(i);if(!k){if(j)break;k=e(i)}if(f.unshift(k),d(i,null),!i)break;j=a.after(i),i=g(i,"previous")}for(i=b.to,j=a.before(b.from);;){if(!i)break;var k=c(i);if(!k){if(j)break;k=e(i)}f.push(k),d(i,null),j=a.before(i),i=g(i,"next")}h.push(f)}}),h},shadowChain:function(a){for(var b=[],c=this.after(a[0].from),d=a[a.length-1].to;;){b.push(c);var e=c.to;if(!e||e==d)break;c=e.historyAfter||this.before(d)}return b},applyChain:function(a){function d(a,b){for(var d=a?a.nextSibling:c.container.firstChild;d!=b;){var e=d.nextSibling;removeElement(d),d=e}}var b=select.cursorPos(this.container,!1),c=this,e=a[0].from,f=a[a.length-1].to;d(e,f);for(var g=0;g<a.length;g++){var h=a[g];g>0&&c.container.insertBefore(h.from,f);var i=makePartSpan(fixSpaces(h.text));if(c.container.insertBefore(i,f),b&&b.node==h.from){var j=0,k=this.after(h.from);if(k&&g==a.length-1){for(var l=0;l<b.offset&&h.text.charAt(l)==k.text.charAt(l);l++);b.offset>l&&(j=h.text.length-k.text.length)}select.setCursorPos(this.container,{node:h.from,offset:Math.max(0,b.offset+j)})}else b&&g==a.length-1&&b.node&&b.node.parentNode!=this.container&&select.setCursorPos(this.container,{node:h.from,offset:h.text.length})}return this.linkChain(a),e}};var internetExplorer=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent),oldIE=internetExplorer&&/MSIE\s+[4-8]\b/.test(navigator.userAgent),webkit=/AppleWebKit/.test(navigator.userAgent),safari=/Apple Computer, Inc/.test(navigator.vendor),gecko=navigator.userAgent.match(/gecko\/(\d{8})/i);gecko&&(gecko=Number(gecko[1]));var mac=/Mac/.test(navigator.platform),brokenOpera=window.opera&&/Version\/10.[56]/.test(navigator.userAgent),slowWebkit=/AppleWebKit\/533/.test(navigator.userAgent),webkitLastLineHack=webkit?function(a){var b=a.lastChild;if(!b||!b.hackBR){var c=document.createElement("br");c.hackBR=!0,a.appendChild(c)}}:function(){},Editor=function(){function b(b,c){function f(b,g){if(3==b.nodeType){var h=b.nodeValue=fixSpaces(b.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "));h.length&&(e=!1),d.push(b)}else if(isBR(b)&&0==b.childNodes.length)e=!0,d.push(b);else{for(var i=b.firstChild;i;i=i.nextSibling)f(i);!e&&a.hasOwnProperty(b.nodeName.toUpperCase())&&(e=!0,c&&g||d.push(document.createElement("br")))}}var d=[],e=!0;return f(b,!0),d}function c(a){function d(a){var b=a.parentNode,c=a.nextSibling;return function(a){b.insertBefore(a,c)}}function g(a){var b="\n";return 3==a.nodeType?(select.snapshotChanged(),a=makePartSpan(a),b=a.currentText,f=!1):(f&&window.opera&&e(makePartSpan("")),f=!0),a.dirty=!0,c.push(a),e(a),b}function h(a,c){for(var d=b(a,c),e=0;e<d.length;e++)d[e]=g(d[e]);return d.join("")}function i(a){if(a.isPart&&1==a.childNodes.length&&3==a.firstChild.nodeType){var b=a.firstChild.nodeValue;return a.dirty=a.dirty||b!=a.currentText,a.currentText=b,!/[\n\t\r]/.test(a.currentText)}return!1}function j(){if(!a)throw StopIteration;var b=a;if(a=b.nextSibling,i(b))return c.push(b),f=!1,b.currentText;if(isBR(b))return f&&window.opera&&b.parentNode.insertBefore(makePartSpan(""),b),c.push(b),f=!0,"\n";var g=!b.nextSibling;return e=d(b),removeElement(b),h(b,g)}var c=[],e=null,f=!0;return{next:j,nodes:c}}function e(a){for(;a&&!isBR(a);)a=a.previousSibling;return a}function f(a,b){for(a?isBR(a)&&(a=a.nextSibling):a=b.firstChild;a&&!isBR(a);)a=a.nextSibling;return a}function g(){return(new Date).getTime()}function h(a,b,c,d){function e(b){var c=cleanText(a.history.textAfter(b));return d?c.toLowerCase():c}this.editor=a,this.history=a.history,this.history.commit(),this.valid=!!b,this.atOccurrence=!1,void 0==d&&(d="string"==typeof b&&b==b.toLowerCase());var f={node:null,offset:0},g=this;if(c&&"object"==typeof c&&"number"==typeof c.character){a.checkLine(c.line);var h={node:c.line,offset:c.character};this.pos={from:h,to:h}}else this.pos=c?{from:select.cursorPos(a.container,!0)||f,to:select.cursorPos(a.container,!1)||f}:{from:f,to:f};if("string"!=typeof b)return this.matches=function(a,c,d){if(a)for(var f=e(c).slice(0,d),h=f.match(b),i=0;h;){var j=f.indexOf(h[0]);i+=j,f=f.slice(j+1);var k=f.match(b);if(!k)break;h=k}else var f=e(c).slice(d),h=f.match(b),i=h&&d+f.indexOf(h[0]);return h?(g.currentMatch=h,{from:{node:c,offset:i},to:{node:c,offset:i+h[0].length}}):void 0},void 0;d&&(b=b.toLowerCase());var i=b.split("\n");this.matches=1==i.length?function(a,c,d){var h,f=e(c),g=b.length;return(a?d>=g&&-1!=(h=f.lastIndexOf(b,d-g)):-1!=(h=f.indexOf(b,d)))?{from:{node:c,offset:h},to:{node:c,offset:h+g}}:void 0}:function(a,b,c){var d=a?i.length-1:0,f=i[d],g=e(b),h=a?g.indexOf(f)+f.length:g.lastIndexOf(f);if(!(a?h>=c||h!=f.length:c>=h||h!=g.length-f.length))for(var j=b;;){if(a&&!j)return;if(j=a?this.history.nodeBefore(j):this.history.nodeAfter(j),!a&&!j)return;if(g=e(j),f=i[a?--d:++d],!(d>0&&d<i.length-1)){var k=a?g.lastIndexOf(f):g.indexOf(f)+f.length;if(a?k!=g.length-f.length:k!=f.length)return;return{from:{node:a?j:b,offset:a?k:h},to:{node:a?b:j,offset:a?h:k}}}if(g!=f)return}}}function i(a){function d(){void 0!=document.body.contentEditable&&internetExplorer?document.body.contentEditable="true":document.designMode="on",internetExplorer&&"dynamic"!=a.height&&(document.body.style.minHeight=window.frameElement.clientHeight-2*document.body.offsetTop-5+"px"),document.documentElement.style.borderWidth="0",a.textWrapping||(b.style.whiteSpace="nowrap")}function g(){c.cursorActivity(!1)}this.options=a,window.indentUnit=a.indentUnit;var b=this.container=document.body;this.history=new UndoHistory(b,a.undoDepth,a.undoDelay,this);var c=this;if(!i.Parser)throw"No parser loaded.";if(a.parserConfig&&i.Parser.configure&&i.Parser.configure(a.parserConfig),a.readOnly||internetExplorer||select.setCursorPos(b,{node:null,offset:0}),this.dirty=[],this.importCode(a.content||""),this.history.onChange=a.onChange,a.readOnly)a.textWrapping||(b.style.whiteSpace="nowrap");else{a.continuousScanning!==!1&&(this.scanner=this.documentScanner(a.passTime),this.delayScanning());try{d()}catch(e){var f=addEventHandler(document,"focus",function(){f(),d()},!0)}addEventHandler(document,"keydown",method(this,"keyDown")),addEventHandler(document,"keypress",method(this,"keyPress")),addEventHandler(document,"keyup",method(this,"keyUp")),addEventHandler(internetExplorer?document.body:window,"mouseup",g),addEventHandler(document.body,"cut",g),gecko&&addEventHandler(window,"pagehide",function(){c.unloaded=!0}),addEventHandler(document.body,"paste",function(a){g();var b=null;try{var d=a.clipboardData||window.clipboardData;d&&(b=d.getData("Text"))}catch(e){}null!==b&&(a.stop(),c.replaceSelection(b),select.scrollToCursor(c.container))}),this.options.autoMatchParens&&addEventHandler(document.body,"click",method(this,"scheduleParenHighlight"))}}function j(a){return a>=16&&18>=a||a>=33&&40>=a}var a={P:!0,DIV:!0,LI:!0};return h.prototype={findNext:function(){return this.find(!1)},findPrevious:function(){return this.find(!0)},find:function(a){function f(){var a={node:d,offset:e};return b.pos={from:a,to:a},b.atOccurrence=!1,!1}if(!this.valid)return!1;var b=this,c=a?this.pos.from:this.pos.to,d=c.node,e=c.offset;for(d&&!d.parentNode&&(d=null,e=0);;){if(this.pos=this.matches(a,d,e))return this.atOccurrence=!0,!0;if(a){if(!d)return f();d=this.history.nodeBefore(d),e=this.history.textAfter(d).length}else{var g=this.history.nodeAfter(d);if(!g)return e=this.history.textAfter(d).length,f();d=g,e=0}}},select:function(){this.atOccurrence&&(select.setCursorPos(this.editor.container,this.pos.from,this.pos.to),select.scrollToCursor(this.editor.container))},replace:function(a){if(this.atOccurrence){var b=this.currentMatch;b&&(a=a.replace(/\\(\d)/,function(a,c){return b[c]}));var c=this.editor.replaceRange(this.pos.from,this.pos.to,a);this.pos.to=c,this.atOccurrence=!1}},position:function(){return this.atOccurrence?{line:this.pos.from.node,character:this.pos.from.offset}:void 0}},i.prototype={importCode:function(a){function f(){var a=b.slice(d,d+c);a.push(""),e.history.push(e.history.nodeBefore(null),null,a),e.history.reset(),d+=c,d<b.length&&parent.setTimeout(f,1e3)}var b=asEditorLines(a),c=1e3;if(!this.options.incrementalLoading||b.length<c)this.history.push(null,null,b),this.history.reset();else{var d=0,e=this;f()}},getCode:function(){if(!this.container.firstChild)return"";var a=[];return select.markSelection(),forEach(c(this.container.firstChild),method(a,"push")),select.selectMarked(),webkit&&this.container.lastChild.hackBR&&a.pop(),webkitLastLineHack(this.container),cleanText(a.join(""))},checkLine:function(a){if(a===!1||null!=a&&a.parentNode!=this.container&&!a.hackBR)throw parent.CodeMirror.InvalidLineHandle},cursorPosition:function(a){null==a&&(a=!0);var b=select.cursorPos(this.container,a);return b?{line:b.node,character:b.offset}:{line:null,character:0}},firstLine:function(){return null},lastLine:function(){var a=this.container.lastChild;return a&&(a=e(a)),a&&a.hackBR&&(a=e(a.previousSibling)),a},nextLine:function(a){this.checkLine(a);var b=f(a,this.container);return!b||b.hackBR?!1:b},prevLine:function(a){return this.checkLine(a),null==a?!1:e(a.previousSibling)},visibleLineCount:function(){for(var a=this.container.firstChild;a&&isBR(a);)a=a.nextSibling;if(!a)return!1;var b=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return Math.floor(b/a.offsetHeight)},selectLines:function(a,b,c,d){this.checkLine(a);var e={node:a,offset:b},f=null;void 0!==d&&(this.checkLine(c),f={node:c,offset:d}),select.setCursorPos(this.container,e,f),select.scrollToCursor(this.container)},lineContent:function(a){var b=[];for(a=a?a.nextSibling:this.container.firstChild;a&&!isBR(a);a=a.nextSibling)b.push(nodeText(a));return cleanText(b.join(""))},setLineContent:function(a,b){this.history.commit(),this.replaceRange({node:a,offset:0},{node:a,offset:this.history.textAfter(a).length},b),this.addDirtyNode(a),this.scheduleHighlight()},removeLine:function(a){for(var b=a?a.nextSibling:this.container.firstChild;b;){var c=b.nextSibling;if(removeElement(b),isBR(b))break;b=c}this.addDirtyNode(a),this.scheduleHighlight()},insertIntoLine:function(a,b,c){var d=null;if("end"==b)d=f(a,this.container);else for(var e=a?a.nextSibling:this.container.firstChild;e;e=e.nextSibling){if(0==b){d=e;break}var g=nodeText(e);if(g.length>b){d=e.nextSibling,c=g.slice(0,b)+c+g.slice(b),removeElement(e);break}b-=g.length}for(var h=asEditorLines(c),i=0;i<h.length;i++)i>0&&this.container.insertBefore(document.createElement("BR"),d),this.container.insertBefore(makePartSpan(h[i]),d);this.addDirtyNode(a),this.scheduleHighlight()},selectedText:function(){var a=this.history;a.commit();var b=select.cursorPos(this.container,!0),c=select.cursorPos(this.container,!1);if(!b||!c)return"";if(b.node==c.node)return a.textAfter(b.node).slice(b.offset,c.offset);for(var d=[a.textAfter(b.node).slice(b.offset)],e=a.nodeAfter(b.node);e!=c.node;e=a.nodeAfter(e))d.push(a.textAfter(e));return d.push(a.textAfter(c.node).slice(0,c.offset)),cleanText(d.join("\n"))},replaceSelection:function(a){this.history.commit();var b=select.cursorPos(this.container,!0),c=select.cursorPos(this.container,!1);b&&c&&(c=this.replaceRange(b,c,a),select.setCursorPos(this.container,c),webkitLastLineHack(this.container))},cursorCoords:function(a,b){function g(a,c){var d=-(document.body.scrollTop||document.documentElement.scrollTop||0),e=-(document.body.scrollLeft||document.documentElement.scrollLeft||0)+c;return forEach([a,b?null:window.frameElement],function(a){for(;a;)e+=a.offsetLeft,d+=a.offsetTop,a=a.offsetParent}),{x:e,y:d,yBot:d+a.offsetHeight}}function h(a,b){var c=document.createElement("SPAN");c.appendChild(document.createTextNode(a));try{return b(c)}finally{c.parentNode&&c.parentNode.removeChild(c)}}var c=select.cursorPos(this.container,a);if(!c)return null;for(var d=c.offset,e=c.node,f=this;d;){e=e?e.nextSibling:this.container.firstChild;var i=nodeText(e);if(d<i.length)return h(i.substr(0,d),function(a){return a.style.position="absolute",a.style.visibility="hidden",a.className=e.className,f.container.appendChild(a),g(e,a.offsetWidth)});d-=i.length}return e&&isSpan(e)?g(e,e.offsetWidth):e&&e.nextSibling&&isSpan(e.nextSibling)?g(e.nextSibling,0):h("\u200b",function(a){return e?e.parentNode.insertBefore(a,e.nextSibling):f.container.insertBefore(a,f.container.firstChild),g(a,0)})},reroutePasteEvent:function(){if(!(this.capturingPaste||window.opera||gecko&&gecko>=20101026)){this.capturingPaste=!0;var a=window.frameElement.CodeMirror.textareaHack,b=this.cursorCoords(!0,!0);if(a.style.top=b.y+"px",oldIE){var c=select.getBookmark(this.container);c&&(this.selectionSnapshot=c)}parent.focus(),a.value="",a.focus();var d=this;parent.setTimeout(function(){d.capturingPaste=!1,window.focus(),d.selectionSnapshot&&window.select.setBookmark(d.container,d.selectionSnapshot);var b=a.value;b&&(d.replaceSelection(b),select.scrollToCursor(d.container))},10)}},replaceRange:function(a,b,c){var d=asEditorLines(c);d[0]=this.history.textAfter(a.node).slice(0,a.offset)+d[0];var e=d[d.length-1];d[d.length-1]=e+this.history.textAfter(b.node).slice(b.offset);var f=this.history.nodeAfter(b.node);return this.history.push(a.node,f,d),{node:this.history.nodeBefore(f),offset:e.length}},getSearchCursor:function(a,b,c){return new h(this,a,b,c)},reindent:function(){this.container.firstChild&&this.indentRegion(null,this.container.lastChild)},reindentSelection:function(a){if(select.somethingSelected()){var b=select.selectionTopNode(this.container,!0),c=select.selectionTopNode(this.container,!1);if(b===!1||c===!1)return;this.indentRegion(b,c,a,!0)}else this.indentAtCursor(a)},grabKeys:function(a,b){this.frozen=a,this.keyFilter=b},ungrabKeys:function(){this.frozen="leave"},setParser:function(a,b){i.Parser=window[a],b=b||this.options.parserConfig,b&&i.Parser.configure&&i.Parser.configure(b),this.container.firstChild&&(forEach(this.container.childNodes,function(a){3!=a.nodeType&&(a.dirty=!0)}),this.addDirtyNode(this.firstChild),this.scheduleHighlight())},keyDown:function(a){if("leave"==this.frozen&&(this.frozen=null,this.keyFilter=null),this.frozen&&(!this.keyFilter||this.keyFilter(a.keyCode,a)))return a.stop(),this.frozen(a),void 0;var b=a.keyCode;if(this.delayScanning(),this.options.autoMatchParens&&this.scheduleParenHighlight(),13==b){if(a.ctrlKey&&!a.altKey)this.reparseBuffer();else{select.insertNewlineAtCursor();var c=this.options.enterMode;"flat"!=c&&this.indentAtCursor("keep"==c?"keep":void 0),select.scrollToCursor(this.container)}a.stop()}else if(9!=b||"default"==this.options.tabMode||a.ctrlKey)if(32==b&&a.shiftKey&&"default"==this.options.tabMode)this.handleTab(!0),a.stop();else if(36!=b||a.shiftKey||a.ctrlKey)if(35!=b||a.shiftKey||a.ctrlKey)if(33!=b||a.shiftKey||a.ctrlKey||gecko)if(34!=b||a.shiftKey||a.ctrlKey||gecko)if(219!=b&&221!=b||!a.ctrlKey||a.altKey)if(!a.metaKey||a.shiftKey||37!=b&&39!=b)!a.ctrlKey&&!a.metaKey||a.altKey||(a.shiftKey&&90==b||89==b?(select.scrollToNode(this.history.redo()),a.stop()):90==b||safari&&8==b?(select.scrollToNode(this.history.undo()),a.stop()):83==b&&this.options.saveFunction?(this.options.saveFunction(),a.stop()):86!=b||mac||this.reroutePasteEvent());
else{var d=select.selectionTopNode(this.container);if(d===!1||!this.container.firstChild)return;if(37==b)select.focusAfterNode(e(d),this.container);else{var g=f(d,this.container);select.focusAfterNode(g?g.previousSibling:this.container.lastChild,this.container)}a.stop()}else this.highlightParens(a.shiftKey,!0),a.stop();else this.pageDown()&&a.stop();else this.pageUp()&&a.stop();else this.end()&&a.stop();else this.home()&&a.stop();else this.handleTab(!a.shiftKey),a.stop()},keyPress:function(a){var b=this.options.electricChars&&i.Parser.electricChars,c=this;if(this.frozen&&(!this.keyFilter||this.keyFilter(a.keyCode||a.code,a))||13==a.code||9==a.code&&"default"!=this.options.tabMode||32==a.code&&a.shiftKey&&"default"==this.options.tabMode)a.stop();else if(mac&&(a.ctrlKey||a.metaKey)&&"v"==a.character)this.reroutePasteEvent();else if(b&&-1!=b.indexOf(a.character))parent.setTimeout(function(){c.indentAtCursor(null)},0);else if(brokenOpera){if(8==a.code){var d=select.selectionTopNode(this.container),c=this,e=d?d.nextSibling:this.container.firstChild;d!==!1&&e&&isBR(e)&&parent.setTimeout(function(){select.selectionTopNode(c.container)==e&&select.focusAfterNode(e.previousSibling,c.container)},20)}else if(46==a.code){var d=select.selectionTopNode(this.container),c=this;d&&isBR(d)&&parent.setTimeout(function(){select.selectionTopNode(c.container)!=d&&select.focusAfterNode(d,c.container)},20)}}else if(slowWebkit){var d=select.selectionTopNode(this.container),e=d?d.nextSibling:this.container.firstChild;if(d&&e&&isBR(e)&&!isBR(d)){var f=document.createTextNode("\u200b");this.container.insertBefore(f,e),parent.setTimeout(function(){"\u200b"==f.nodeValue?removeElement(f):f.nodeValue=f.nodeValue.replace("\u200b","")},20)}}webkit&&!this.options.textWrapping&&setTimeout(function(){var a=select.selectionTopNode(c.container,!0);a&&3==a.nodeType&&a.previousSibling&&isBR(a.previousSibling)&&a.nextSibling&&isBR(a.nextSibling)&&a.parentNode.replaceChild(document.createElement("BR"),a.previousSibling)},50)},keyUp:function(a){this.cursorActivity(j(a.keyCode))},indentLineAfter:function(a,b){function c(a){var b=a?a.nextSibling:d.container.firstChild;return b&&hasClass(b,"whitespace")?b:null}var d=this,f=c(a),g=0,h=f?f.currentText.length:0,j=f?f.nextSibling:a?a.nextSibling:this.container.firstChild;if("keep"==b){if(a){var k=c(e(a.previousSibling));k&&(g=k.currentText.length)}}else{var l=a&&j&&j.currentText?j.currentText:"";null!=b&&"indent"!=this.options.tabMode?g=b?h+indentUnit:Math.max(0,h-indentUnit):a?g=a.indentation(l,h,b,j):i.Parser.firstIndentation&&(g=i.Parser.firstIndentation(l,h,b,j))}var m=g-h;0>m?0==g?(j&&select.snapshotMove(f.firstChild,j.firstChild||j,0),removeElement(f),f=null):(select.snapshotMove(f.firstChild,f.firstChild,m,!0),f.currentText=makeWhiteSpace(g),f.firstChild.nodeValue=f.currentText):m>0?f?(f.currentText=makeWhiteSpace(g),f.firstChild.nodeValue=f.currentText,select.snapshotMove(f.firstChild,f.firstChild,m,!0)):(f=makePartSpan(makeWhiteSpace(g)),f.className="whitespace",a?insertAfter(f,a):this.container.insertBefore(f,this.container.firstChild),select.snapshotMove(j&&(j.firstChild||j),f.firstChild,g,!1,!0)):f&&select.snapshotMove(f.firstChild,f.firstChild,g,!1),0!=m&&this.addDirtyNode(a)},highlightAtCursor:function(){var a=select.selectionTopNode(this.container,!0),b=select.selectionTopNode(this.container,!1);return a===!1||b===!1?!1:(select.markSelection(),this.highlight(a,f(b,this.container),!0,20)===!1?!1:(select.selectMarked(),!0))},handleTab:function(a){"spaces"!=this.options.tabMode||select.somethingSelected()?this.reindentSelection(a):select.insertTabAtCursor()},home:function(){var a=select.selectionTopNode(this.container,!0),b=a;if(a===!1||a&&!a.isPart&&!isBR(a)||!this.container.firstChild)return!1;for(;a&&!isBR(a);)a=a.previousSibling;var c=a?a.nextSibling:this.container.firstChild;return c&&c!=b&&c.isPart&&hasClass(c,"whitespace")?select.focusAfterNode(c,this.container):select.focusAfterNode(a,this.container),select.scrollToCursor(this.container),!0},end:function(){var a=select.selectionTopNode(this.container,!0);return a===!1?!1:(a=f(a,this.container))?(select.focusAfterNode(a.previousSibling,this.container),select.scrollToCursor(this.container),!0):!1},pageUp:function(){var a=this.cursorPosition().line,b=this.visibleLineCount();if(a===!1||b===!1)return!1;b-=2;for(var c=0;b>c&&(a=this.prevLine(a),a!==!1);c++);return 0==c?!1:(select.setCursorPos(this.container,{node:a,offset:0}),select.scrollToCursor(this.container),!0)},pageDown:function(){var a=this.cursorPosition().line,b=this.visibleLineCount();if(a===!1||b===!1)return!1;b-=2;for(var c=0;b>c;c++){var d=this.nextLine(a);if(d===!1)break;a=d}return 0==c?!1:(select.setCursorPos(this.container,{node:a,offset:0}),select.scrollToCursor(this.container),!0)},scheduleParenHighlight:function(){this.parenEvent&&parent.clearTimeout(this.parenEvent);var a=this;this.parenEvent=parent.setTimeout(function(){a.highlightParens()},300)},highlightParens:function(a,b){function e(a,b){a&&(d?d.call?d(a,b):a.className+=" "+d[b?0:1]:(a.style.fontWeight="bold",a.style.color=b?"#8F8":"#F88"))}function g(a){a&&(d&&!d.call?removeClass(removeClass(a,d[0]),d[1]):c.options.unmarkParen?c.options.unmarkParen(a):(a.style.fontWeight="",a.style.color=""))}function h(a){if(a.currentText){var b=a.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/);return b&&b[1]}}function i(a){return/[\(\[\{]/.test(a)}function o(){for(var b,a=[],c=!0,d=k;d;d=m?d.nextSibling:d.previousSibling)if(d.className==l&&isSpan(d)&&(b=h(d))){if(i(b)==m?a.push(b):a.length?a.pop()!=matching[b]&&(c=!1):c=!1,!a.length)break}else if(d.dirty||!isSpan(d)&&!isBR(d))return{node:d,status:"dirty"};return{node:d,status:d&&c}}var c=this,d=this.options.markParen;if("string"==typeof d&&(d=[d,d]),!b&&c.highlighted&&(g(c.highlighted[0]),g(c.highlighted[1])),window&&window.parent&&window.select){this.parenEvent&&parent.clearTimeout(this.parenEvent),this.parenEvent=null;var j,k=select.selectionTopNode(this.container,!0);if(k&&this.highlightAtCursor()&&(k=select.selectionTopNode(this.container,!0),k&&((j=h(k))||(k=k.nextSibling)&&(j=h(k))))){var l=k.className,m=i(j);for(matching[j];;){var p=o();{if("dirty"!=p.status){e(k,p.status),e(p.node,p.status),b?parent.setTimeout(function(){g(k),g(p.node)},500):c.highlighted=[k,p.node],a&&p.node&&select.focusAfterNode(p.node.previousSibling,this.container);break}this.highlight(p.node,f(p.node)),p.node.dirty=!1}}}}},indentAtCursor:function(a){if(this.container.firstChild&&this.highlightAtCursor()){var b=select.selectionTopNode(this.container,!1);b!==!1&&(select.markSelection(),this.indentLineAfter(e(b),a),select.selectMarked())}},indentRegion:function(a,b,c,d){var g=a=e(a),h=a&&e(a.previousSibling);isBR(b)||(b=f(b,this.container)),this.addDirtyNode(a);do{var i=f(g,this.container);g&&this.highlight(h,i,!0),this.indentLineAfter(g,c),h=g,g=i}while(g!=b);d&&select.setCursorPos(this.container,{node:a,offset:0},{node:b,offset:0})},cursorActivity:function(a){if(this.unloaded&&(window.document.designMode="off",window.document.designMode="on",this.unloaded=!1),oldIE){this.container.createTextRange().execCommand("unlink"),clearTimeout(this.saveSelectionSnapshot);var b=this;this.saveSelectionSnapshot=setTimeout(function(){var a=select.getBookmark(b.container);a&&(b.selectionSnapshot=a)},200)}var c=this.options.onCursorActivity;if(!a||c){var d=select.selectionTopNode(this.container,!1);if(d===!1||!this.container.firstChild)return;d=d||this.container.firstChild,c&&c(d),a||(this.scheduleHighlight(),this.addDirtyNode(d))}},reparseBuffer:function(){forEach(this.container.childNodes,function(a){a.dirty=!0}),this.container.firstChild&&this.addDirtyNode(this.container.firstChild)},addDirtyNode:function(a){if(a=a||this.container.firstChild){for(var b=0;b<this.dirty.length;b++)if(this.dirty[b]==a)return;3!=a.nodeType&&(a.dirty=!0),this.dirty.push(a)}},allClean:function(){return!this.dirty.length},scheduleHighlight:function(){var a=this;parent.clearTimeout(this.highlightTimeout),this.highlightTimeout=parent.setTimeout(function(){a.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){for(;this.dirty.length>0;){var a=this.dirty.pop();try{for(;a&&a.parentNode!=this.container;)a=a.parentNode;if(a&&(a.dirty||3==a.nodeType))return a}catch(b){}}return null},highlightDirty:function(a){if(!window||!window.parent||!window.select)return!1;this.options.readOnly||select.markSelection();for(var b,c=a?null:g()+this.options.passTime;(g()<c||a)&&(b=this.getDirtyNode());){var d=this.highlight(b,c);d&&d.node&&d.dirty&&this.addDirtyNode(d.node.nextSibling)}return this.options.readOnly||select.selectMarked(),b&&this.scheduleHighlight(),0==this.dirty.length},documentScanner:function(a){var b=this,c=null;return function(){if(window&&window.parent&&window.select){c&&c.parentNode!=b.container&&(c=null),select.markSelection();var d=b.highlight(c,g()+a,!0);select.selectMarked();var e=d?d.node&&d.node.nextSibling:null;c=c==e?null:e,b.delayScanning()}}},delayScanning:function(){this.scanner&&(parent.clearTimeout(this.documentScan),this.documentScan=parent.setTimeout(this.scanner,this.options.continuousScanning))},highlight:function(a,b,d,e){function l(a,b){return!b.reduced&&b.currentText==a.value&&b.className==a.style}function m(a,b){a.currentText=a.currentText.substring(b),a.reduced=!0}function n(a){var b=makePartSpan(a.value);return b.className=a.style,b}function o(a){if(a){var b=a.oldNextSibling;(u||void 0===b||a.nextSibling!=b)&&h.history.touch(a),a.oldNextSibling=a.nextSibling}else{var b=h.container.oldFirstChild;(u||void 0===b||h.container.firstChild!=b)&&h.history.touch(null),h.container.oldFirstChild=h.container.firstChild}}function s(a){return(null==a.previousSibling||isBR(a.previousSibling))&&(null==a.nextSibling||isBR(a.nextSibling))}var f=this.container,h=this,j=this.options.activeTokens,k="number"==typeof b?b:null;if(!f.firstChild)return!1;for(;a&&(!a.parserFromHere||a.dirty);){if(null!=e&&isBR(a)&&--e<0)return!1;a=a.previousSibling}if(a&&!a.nextSibling)return!1;var p=c(a?a.nextSibling:f.firstChild),q=stringStream(p),r=a?a.parserFromHere(q):i.Parser.make(q),t={current:null,get:function(){return this.current||(this.current=p.nodes.shift()),this.current},next:function(){this.current=null},remove:function(){f.removeChild(this.get()),this.current=null},getNonEmpty:function(){for(var a=this.get();a&&isSpan(a)&&""==a.currentText;)if(window.opera&&s(a))this.next(),a=this.get();else{var b=a;this.remove(),a=this.get(),select.snapshotMove(b.firstChild,a&&(a.firstChild||a),0)}return a}},u=!1,v=!0,w=0;return forEach(r,function(c){var e=t.getNonEmpty();if("\n"==c.value){if(!isBR(e))throw"Parser out of sync. Expected BR.";if((e.dirty||!e.indentation)&&(u=!0),o(a),a=e,e.parserFromHere=r.copy(),e.indentation=c.indentation||alwaysZero,e.dirty=!1,null==k&&e==b)throw StopIteration;if(null!=k&&g()>=k||!u&&!v&&w>1&&!d)throw StopIteration;v=u,u=!1,w=0,t.next()}else{if(!isSpan(e))throw"Parser out of sync. Expected SPAN.";if(e.dirty&&(u=!0),w++,l(c,e))j&&e.dirty&&j(e,c,h),e.dirty=!1,t.next();else{u=!0;var i=n(c);f.insertBefore(i,e),j&&j(i,c,h);for(var p=c.value.length,q=0;p>0;){e=t.get();var s=e.currentText.length;select.snapshotReplaceNode(e.firstChild,i.firstChild,p,q),s>p?(m(e,p),p=0):(p-=s,q+=s,t.remove())}}}}),o(a),webkitLastLineHack(this.container),{node:t.getNonEmpty(),dirty:u}}},i}();addEventHandler(window,"load",function(){var a=window.frameElement.CodeMirror;a.editor=new Editor(a.options),parent.setTimeout(method(a,"init"),0)});var luaCustomFunctions=matchRegexp([]),luaStdFunctions=matchRegexp(["_G","_VERSION","assert","collectgarbage","dofile","error","getfenv","getmetatable","ipairs","load","loadfile","loadstring","module","next","pairs","pcall","print","rawequal","rawget","rawset","require","select","setfenv","setmetatable","tonumber","tostring","type","unpack","xpcall","coroutine.create","coroutine.resume","coroutine.running","coroutine.status","coroutine.wrap","coroutine.yield","debug.debug","debug.getfenv","debug.gethook","debug.getinfo","debug.getlocal","debug.getmetatable","debug.getregistry","debug.getupvalue","debug.setfenv","debug.sethook","debug.setlocal","debug.setmetatable","debug.setupvalue","debug.traceback","close","flush","lines","read","seek","setvbuf","write","io.close","io.flush","io.input","io.lines","io.open","io.output","io.popen","io.read","io.stderr","io.stdin","io.stdout","io.tmpfile","io.type","io.write","math.abs","math.acos","math.asin","math.atan","math.atan2","math.ceil","math.cos","math.cosh","math.deg","math.exp","math.floor","math.fmod","math.frexp","math.huge","math.ldexp","math.log","math.log10","math.max","math.min","math.modf","math.pi","math.pow","math.rad","math.random","math.randomseed","math.sin","math.sinh","math.sqrt","math.tan","math.tanh","os.clock","os.date","os.difftime","os.execute","os.exit","os.getenv","os.remove","os.rename","os.setlocale","os.time","os.tmpname","package.cpath","package.loaded","package.loaders","package.loadlib","package.path","package.preload","package.seeall","string.byte","string.char","string.dump","string.find","string.format","string.gmatch","string.gsub","string.len","string.lower","string.match","string.rep","string.reverse","string.sub","string.upper","table.concat","table.insert","table.maxn","table.remove","table.sort"]),luaKeywords=matchRegexp(["and","break","elseif","false","nil","not","or","return","true","function","end","if","then","else","do","while","repeat","until","for","in","local"]),luaIndentKeys=matchRegexp(["function","if","repeat","for","while","[(]","{"]),luaUnindentKeys=matchRegexp(["end","until","[)]","}"]),luaUnindentKeys2=findFirstRegexp(["end","until","[)]","}"]),luaMiddleKeys=findFirstRegexp(["else","elseif"]),LUAParser=Editor.Parser=function(){function b(a,b){return function(c){var d=luaUnindentKeys2.test(c)||luaMiddleKeys.test(c);return b+indentUnit*(a-(d?1:0))}}function c(c,d){d=d||0;var e=a(c),f=0,g={next:function(){var a=e.next(),c=a.style,g=a.content;return"lua-identifier"==c&&luaKeywords.test(g)&&(a.style="lua-keyword"),"lua-identifier"==c&&luaStdFunctions.test(g)&&(a.style="lua-stdfunc"),"lua-identifier"==c&&luaCustomFunctions.test(g)&&(a.style="lua-customfunc"),"lua-comment"!=c&&"lua-string"!=c&&(luaIndentKeys.test(g)?f++:luaUnindentKeys.test(g)&&f--),"\n"==g&&(a.indentation=b(f,d)),a},copy:function(){var b=e.state,c=f;return function(d){return e=a(d,b),f=c,g}}};return g}var a=function(){function a(a,e){var f=a.next();if("-"==f&&a.equals("-"))return a.next(),e(b),null;if('"'==f||"'"==f)return e(d(f)),null;if("["==f&&(a.equals("[")||a.equals("="))){for(var g=0;a.equals("=");)g++,a.next();return a.equals("[")?(e(c(g,"lua-string")),null):"lua-error"}return"="==f?(a.equals("=")&&a.next(),"lua-token"):"."==f?(a.equals(".")&&a.next(),a.equals(".")&&a.next(),"lua-token"):"+"==f||"-"==f||"*"==f||"/"==f||"%"==f||"^"==f||"#"==f?"lua-token":">"==f||"<"==f||"("==f||")"==f||"{"==f||"}"==f||"["==f?"lua-token":"]"==f||";"==f||":"==f||","==f?"lua-token":!a.equals("=")||"~"!=f&&"<"!=f&&">"!=f?/\d/.test(f)?(a.nextWhileMatches(/[\w.%]/),"lua-number"):(a.nextWhileMatches(/[\w\\\-_.]/),"lua-identifier"):(a.next(),"lua-token")}function b(b,d){for(var e=!0;!b.endOfLine();){var g=b.next(),h=0;if("["==g&&e){for(;b.equals("=");)b.next(),h++;if(b.equals("["))return d(c(h,"lua-comment")),null}e=!1}return d(a),"lua-comment"}function c(b,c){return function(d,e){for(var f=0;!d.endOfLine();){var g=d.next();if(f==b+1&&"]"==g){e(a);break}f=0==f?"]"==g?1:0:"="==g?f+1:0}return c}}function d(b){return function(c,d){for(var e=!1;!c.endOfLine();){var f=c.next();if(f==b&&!e)break;e=!e&&"\\"==f}return e||d(a),"lua-string"}}return function(b,c){return tokenizer(b,c||a)}}();return{make:c,configure:configureLUA,electricChars:"delf})"}}();